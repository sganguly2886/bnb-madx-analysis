BNB Narrow Beam Analysis Prescription

This document provides the complete, step-by-step workflow used to perform the BNB narrow beam optics analysis using MAD-X and Python. Following these steps reproduces all numerical results and figures in this repository.

------------------------------------------------------------

1. MAD-X Lattice Preparation

All lattice files are stored in:

0_madx_lattices/

Baseline Configurations:
- bnbnew_default.madx
- bnbnew_fixed.madx

Quadrupole Scan Configurations:

HQ873 scans:
- bnbnew_HQ873_*
- bnbnew_HQ873K1_*

HQ874 scans:
- bnbnew_HQ874_*
- bnbnew_IQ874_*
- bnbnew_HQ873_874_*

HQ875 scans:
- bnbnew_HQ875_*
- bnbnew_IQ875_*

These files define all optics variations used in the study.

------------------------------------------------------------

2. Generate Twiss Outputs with MAD-X

All Twiss files are generated by running MAD-X on the lattice files.

Example:

madx < bnbnew_HQ873_default.madx

Automated scan execution:

python run_HQ873.py  
python run_HQ874.py  
python run_HQ875.py  

These commands generate:

- twiss_Q873_*.tfs  
- twiss_Q874_*.tfs  
- twiss_Q875_*.tfs  

Outputs are saved to:

1_twiss_outputs/

------------------------------------------------------------

3. Extract Beta and Dispersion at Wire Chambers

Run:

python plot_twiss_updated.py

This script extracts:

- beta_x  
- beta_y  

at MW873, MW875, MW876

and:

- D_x  
- D_y  

at MW873, MW875, MW876

Outputs are written to:

3_results/csv/

Including:

- betax_vs_Q873_current.csv  
- dispersion_vs_Q873_current.csv  
- Corresponding HQ874 and HQ875 files  

------------------------------------------------------------

4. Fit Emittance and Momentum Spread

Run:

python analyze_emittance_dispersion.py

This solves the beam size model:

sigma^2 = epsilon * beta + (sigma_delta * D)^2

where:

- sigma = RMS beam size  
- epsilon = geometric RMS emittance  
- beta = beta function  
- sigma_delta = RMS fractional momentum spread  
- D = dispersion  

The script extracts:

- epsilon_x, epsilon_y  
- sigma_delta  

Outputs:

- Emittance CSV files  
- Momentum spread CSV files  

Examples:

- emittance_vs_Q873_current.csv  
- momentum_spread_vs_Q873_current.csv  
- Corresponding HQ874 and HQ875 files  

------------------------------------------------------------

5. Predict Target Beam Spot Size

Run:

python cal_spotsize.py

This propagates the beam to the BNB target (approximately 207 meters) and computes:

sigma_x_target  
sigma_y_target  
A = sigma_x_target * sigma_y_target

Outputs:

- target_sigma_prediction_scaled_D_Q873.csv  
- target_sigma_prediction_scaled_D_Q874.csv  
- target_sigma_prediction_scaled_D_Q875.csv  

These files contain:

- Predicted horizontal beam size at the target  
- Predicted vertical beam size at the target  
- Effective two-dimensional beam spot area  

------------------------------------------------------------

6. Generate Final Plots

Plotting scripts include:

- plot_betax_dx.py  
- plot_betx_dx_HQ873_874_joint_variation.py  
- Emittance and target spot visualization scripts  

All figures are saved to:

3_results/figures/

These include:

- Beta-function scan plots  
- Dispersion scan plots  
- Emittance and momentum spread plots  
- Wire chamber beam size plots  
- Target beam spot optimization plots  

------------------------------------------------------------

7. Scientific Interpretation Layer

Final conclusions are drawn using:

- Target spot area minimization  
- Global versus local optics minima comparison  
- Dispersion-dominated sigma_x behavior  
- Vertical focusing sensitivity via Q875  

Key conclusions supported by this workflow include:

- Q873 controls the dominant horizontal focusing behavior  
- Q874 primarily affects dispersion-driven beam growth  
- Q875 influences vertical envelope stability  
- True beam optimization requires minimizing sigma_x_target * sigma_y_target, not beta_x alone  

------------------------------------------------------------

Software Requirements

- MAD-X (CERN)  
- Python 3.8 or higher  
- NumPy  
- Pandas  
- Matplotlib  

------------------------------------------------------------

Reproducibility Statement

This prescription guarantees that every figure and numerical result in this repository can be reproduced from the raw MAD-X lattices using only the scripts provided here.

